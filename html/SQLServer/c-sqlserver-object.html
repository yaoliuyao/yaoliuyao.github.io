<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-01-22 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Objects in SQLServer</title>
<meta name="generator" content="Org mode">
<meta name="author" content="孙悟空">
<link rel='stylesheet' href='/html/asset/common.css?3344' />
<link rel='stylesheet' href='/yaoliusan/html/asset/common.css?3344' />
<script src='https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
<script src='/html/asset/common.js'></script>
<script src='/yaoliusan/html/asset/common.js'></script>

<style>
 /* From: https://endlessparentheses.com/public/css/endless.css */
 .special-kbd {
   color: #333;
   background-color: #f7f7f7;
   border: 1px solid #ccc;
   border-radius: 6px;
   box-shadow: 0 1px 0 rgba(0,0,0,0.2),0 0 0 2px #fff inset;
   display: inline-block;
   font-family: 'Droid Sans Mono', monospace;
   font-size: 80%;
   font-weight: normal;
   line-height: inherit;
   margin: 2px .1em;
   padding: .04em .4em;
   text-shadow: 0 1px 0 #fff;
   word-spacing: -3px;
 }
</style>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Objects in SQLServer</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgae2613f">1. Index (查询效率)</a>
<ul>
<li><a href="#orgb4ea806">1.1. 什么是 Index</a></li>
<li><a href="#org051d0e6">1.2. 如何使用索引</a></li>
</ul>
</li>
<li><a href="#org0fbb781">2. View (简化语句)</a></li>
</ul>
</div>
</nav>


<section id="outline-container-orgae2613f" class="outline-2">
<h2 id="orgae2613f"><span class="section-number-2">1</span> Index (查询效率)</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgb4ea806" class="outline-3">
<h3 id="orgb4ea806"><span class="section-number-3">1.1</span> 什么是 Index</h3>
<div class="outline-text-3" id="text-1-1">
<p>
基本原理:
</p>
<ul class="org-ul">
<li>以空间换时间</li>
<li>避免 full table scan, 效率最低</li>
</ul>

<p>
空间基本构建步骤:
</p>
<ol class="org-ol">
<li>创建一片空间，存储 <b>排序良好</b> 的数据</li>
<li>对排序好的数据，进行有效的 <b>分组</b>
<ul class="org-ul">
<li>根据策略的不同，分组可以能有很多不同的算法</li>
<li>目前比较流行，也比较高效的是 B-Tree 算法</li>
</ul></li>
</ol>


<figure id="org0636294">
<img src="img/b-tree-demo.png" alt="b-tree-demo.png">

</figure>

<p>
基本查询步骤:
</p>
<ol class="org-ol">
<li>首先，寻找刚才的空间，找到所有符合条件的数据和其地址</li>
<li>其次，根据上述的地址，从原先的表中定位并获取所有对应数据</li>
</ol>


<figure id="org5668625">
<img src="img/what-is-index.png" alt="what-is-index.png">

</figure>


<p>
上述定义的额外存储空间，就叫 <b>索引(index)</b>!!!
</p>

<p>
索引具备两面性，要客观使用:
</p>
<ul class="org-ul">
<li>它能极大提高查询速度 (5m - 0.2s)</li>
<li>它 <b>不一定</b> 能提高查询速度，甚至可能会降低</li>
<li>它需要占用很多额外的存储空间</li>
<li>它需要额外的成本进行维护 (插入/删除/更新)，会削弱相应的效率</li>
<li>在右模糊或全模糊查询的时候，数据库不会走索引</li>
<li>性别等字段，离散型比较差，不适合建立 (普通) 索引</li>
</ul>
</div>
</div>

<div id="outline-container-org051d0e6" class="outline-3">
<h3 id="org051d0e6"><span class="section-number-3">1.2</span> 如何使用索引</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #687080; font-style: italic;">-- &#22522;&#26412;&#30340;&#21019;&#24314;</span>
<span style="color: #c678dd; font-weight: bold;">create</span> index index_lagou_position_pos
  <span style="color: #c678dd; font-weight: bold;">on</span> lagou_position<span style="color: #8c8c8c;">(</span><span style="color: #c678dd; font-weight: bold;">position</span><span style="color: #8c8c8c;">)</span>;

<span style="color: #687080; font-style: italic;">-- &#32858;&#38598;&#32034;&#24341; (&#26159;&#33021;&#22815;&#30452;&#25509;&#24178;&#39044;&#20027;&#34920;&#19978;&#39034;&#24207;&#30340;&#29289;&#29702;&#25490;&#24207;&#30340;&#32034;&#24341;&#12290;&#19968;&#20010;&#34920;&#26368;&#22810;&#21482;&#33021;&#26377;&#19968;&#20010;&#12290;&#19968;&#33324;&#26469;&#35828;&#65292;&#23601;&#26159;&#20027;&#38190;&#19978;&#30340;&#32034;&#24341;)</span>
<span style="color: #c678dd; font-weight: bold;">create</span> clustered index index_lagou_position_pid
  <span style="color: #c678dd; font-weight: bold;">on</span> lagou_position<span style="color: #8c8c8c;">(</span>pid<span style="color: #8c8c8c;">)</span>;

<span style="color: #687080; font-style: italic;">-- &#20854;&#20182;&#32034;&#24341;</span>
<span style="color: #c678dd; font-weight: bold;">create</span> index idx_xxx <span style="color: #c678dd; font-weight: bold;">on</span> lagou_position <span style="color: #8c8c8c;">(</span>city, field<span style="color: #8c8c8c;">)</span>; <span style="color: #687080; font-style: italic;">-- &#32852;&#21512;&#32034;&#24341;</span>
<span style="color: #c678dd; font-weight: bold;">create</span> index idx_yyy <span style="color: #c678dd; font-weight: bold;">on</span> lagou_position xxx<span style="color: #8c8c8c;">(</span>city<span style="color: #8c8c8c;">)</span>;     <span style="color: #687080; font-style: italic;">-- &#20989;&#25968;&#32034;&#24341;</span>

<span style="color: #687080; font-style: italic;">-- &#20462;&#25913;</span>
<span style="color: #c678dd; font-weight: bold;">alter</span> index index_lagou_position_pos <span style="color: #c678dd; font-weight: bold;">on</span> lagou_position rebuild/reorganize/disable;

<span style="color: #687080; font-style: italic;">-- &#21024;&#38500;</span>
<span style="color: #c678dd; font-weight: bold;">drop</span> index index_lagou_position_pos <span style="color: #c678dd; font-weight: bold;">on</span> lagou_position;
</pre>
</div>

<p>
对比:
</p>


<figure id="org9032984">
<img src="img/diff-before-and-after-index.png" alt="diff-before-and-after-index.png">

</figure>
</div>
</div>
</section>



<section id="outline-container-org0fbb781" class="outline-2">
<h2 id="org0fbb781"><span class="section-number-2">2</span> View (简化语句)</h2>
<div class="outline-text-2" id="text-2">
<p>
视图 (View) 的创建:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #687080; font-style: italic;">-- &#21333;&#34920;&#21152;&#26465;&#20214;</span>
<span style="color: #c678dd; font-weight: bold;">create</span> <span style="color: #c678dd; font-weight: bold;">view</span> <span style="color: #61afef;">xxx</span>
  <span style="color: #c678dd; font-weight: bold;">as</span>
  <span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> lagou_position <span style="color: #c678dd; font-weight: bold;">where</span> city = <span style="color: #98be65;">'&#29664;&#28023;'</span>;

<span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> xxx;

<span style="color: #687080; font-style: italic;">-- &#22810;&#34920;&#21152;&#26465;&#20214;</span>
<span style="color: #c678dd; font-weight: bold;">create</span> <span style="color: #c678dd; font-weight: bold;">view</span> <span style="color: #61afef;">v_yyy</span>
  <span style="color: #c678dd; font-weight: bold;">as</span>
  <span style="color: #c678dd; font-weight: bold;">select</span> p.*, c.fullname, c.<span style="color: #c678dd; font-weight: bold;">size</span> <span style="color: #c678dd; font-weight: bold;">from</span> lagou_position p
   <span style="color: #c678dd; font-weight: bold;">join</span> lagou_company c <span style="color: #c678dd; font-weight: bold;">on</span> c.cid = p.company
   <span style="color: #c678dd; font-weight: bold;">where</span> city = <span style="color: #98be65;">'&#29664;&#28023;'</span> <span style="color: #c678dd; font-weight: bold;">or</span> city = <span style="color: #98be65;">'&#28145;&#22323;'</span> <span style="color: #c678dd; font-weight: bold;">or</span> city = <span style="color: #98be65;">'&#24191;&#24030;'</span>;

<span style="color: #c678dd; font-weight: bold;">select</span> <span style="color: #61afef; font-weight: bold;">COUNT</span><span style="color: #8c8c8c;">(</span>*<span style="color: #8c8c8c;">)</span> <span style="color: #c678dd; font-weight: bold;">from</span> yyy;
<span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> yyy <span style="color: #c678dd; font-weight: bold;">order</span> <span style="color: #c678dd; font-weight: bold;">by</span> salary_max <span style="color: #c678dd; font-weight: bold;">desc</span>;

<span style="color: #687080; font-style: italic;">-- &#20462;&#25913;&#35270;&#22270;</span>
<span style="color: #c678dd; font-weight: bold;">alter</span> <span style="color: #c678dd; font-weight: bold;">view</span> <span style="color: #61afef;">v_yyy</span>
   <span style="color: #c678dd; font-weight: bold;">with</span> encryption
   <span style="color: #c678dd; font-weight: bold;">with</span> <span style="color: #c678dd; font-weight: bold;">check</span> <span style="color: #c678dd; font-weight: bold;">option</span>
  <span style="color: #c678dd; font-weight: bold;">as</span>
  <span style="color: #c678dd; font-weight: bold;">select</span> p.*, c.fullname, c.<span style="color: #c678dd; font-weight: bold;">size</span> <span style="color: #c678dd; font-weight: bold;">from</span> lagou_position p
   <span style="color: #c678dd; font-weight: bold;">join</span> lagou_company c <span style="color: #c678dd; font-weight: bold;">on</span> c.cid = p.company
   <span style="color: #c678dd; font-weight: bold;">where</span> city = <span style="color: #98be65;">'&#29664;&#28023;'</span> <span style="color: #c678dd; font-weight: bold;">or</span> city = <span style="color: #98be65;">'&#28145;&#22323;'</span> <span style="color: #c678dd; font-weight: bold;">or</span> city = <span style="color: #98be65;">'&#24191;&#24030;'</span> <span style="color: #c678dd; font-weight: bold;">or</span> city = <span style="color: #98be65;">'&#19996;&#33694;'</span>;

<span style="color: #687080; font-style: italic;">-- &#21024;&#38500;</span>
<span style="color: #c678dd; font-weight: bold;">drop</span> <span style="color: #c678dd; font-weight: bold;">view</span> <span style="color: #61afef;">v_yyy</span>;
</pre>
</div>

<p>
其他的一些语句:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #687080; font-style: italic;">-- &#21487;&#20197;&#36890;&#36807;&#31995;&#32479; "&#34920;" &#26469;&#26597;&#35810;&#30456;&#20851;&#30340;&#20449;&#24687;</span>
<span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> sys.objects;
<span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> sys.columns;
<span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> sys.depends;
<span style="color: #c678dd; font-weight: bold;">select</span> * <span style="color: #c678dd; font-weight: bold;">from</span> sys.comments;

<span style="color: #687080; font-style: italic;">-- &#21487;&#20197;&#36890;&#36807;&#23384;&#20648;&#36807;&#31243;&#26597;&#30475;&#32467;&#26500;</span>
sp_help xxx;
sp_helptext xxx;
sp_helptext <span style="color: #8c8c8c;">[</span>sys.objects<span style="color: #8c8c8c;">]</span>;
</pre>
</div>

<p>
优点:
</p>
<ul class="org-ul">
<li>简化 sql 语句</li>
<li>加强对数据的权限控制</li>
</ul>

<p>
另外:
</p>
<ul class="org-ul">
<li>主要用于查询</li>
<li>也可以进行有限的 <i>增删改</i></li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: 孙悟空</p>
<p class="date">Created: 2021-01-22</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
