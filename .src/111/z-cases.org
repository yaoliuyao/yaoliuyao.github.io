#+TITLE: 一万行代码



* 阶梯电费计算
** 第一种解决方案

这种方式由第三小组提供:
#+begin_src csharp -n
  class 电费计算
  {
      // 需要知道的数据
      private int _月份;
      private double _电数;

      // 需要计算出来的数据
      public double 第一档电费 { get; private set; }
      public double 第二档电费 { get; private set; }
      public double 第三档电费 { get; private set; }
      public double 总电费 { get; private set; }

      // 基准数据
      public static readonly double[] 档费 = new double[] { 0.600, 0.650, 0.900 };

      public int 月份
      {
          get { return _月份; }
          set
          {
              if (value < 1 || value > 12)
              {
                  Console.WriteLine("参数输入错误。");
                  Environment.Exit(0);
              }
              _月份 = value;
              计算电费();
          }
      }

      public double 电数
      {
          get { return _电数; }
          set
          {
              if (value < 0)
              {
                  Console.WriteLine("参数输入错误。");
                  Environment.Exit(0);
              }
              _电数 = value;
              计算电费();
          }
      }

      public void 计算电费()
      {
          if (_月份 >= 5 && _月份 <= 10)
          {
              if (_电数 <= 260)
              {
                  第一档电费 = _电数 * 档费[0];
                  第二档电费 = 0;
                  第三档电费 = 0;
              }
              else if (_电数 <= 600)
              {
                  第一档电费 = 260 * 档费[0];
                  第二档电费 = (_电数 - 260) * (档费[1]);
                  第三档电费 = 0;
              }
              else if (_电数 > 600)
              {
                  第一档电费 = 260 * 档费[0];
                  第二档电费 = (600 - 260) * (档费[1]);
                  第三档电费 = (_电数 - 600) * (档费[2]);
              }
          }
          else
          {
              if (_电数 > 0 && _电数 <= 200)
              {
                  第一档电费 = _电数 * 档费[0];
                  第二档电费 = 0;
                  第三档电费 = 0;
              }
              else if (_电数 > 200 && _电数 <= 400)
              {
                  第一档电费 = 200 * 档费[0];
                  第二档电费 = (_电数 - 200) * (档费[1]);
                  第三档电费 = 0;
              }
              else if (_电数 > 400)
              {
                  第一档电费 = 200 * 档费[0];
                  第二档电费 = (400 - 200) * (档费[1]);
                  第三档电费 = (_电数 - 400) * (档费[2]);
              }
          }
          总电费 = 第一档电费 + 第二档电费 + 第三档电费;
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"{_月份} 月的用电量是: {_电数} KWh");
          Console.WriteLine($"第一档电费: { 第一档电费,10:C}");
          Console.WriteLine($"第二档电费: { 第二档电费,10:C}");
          Console.WriteLine($"第三档电费: { 第三档电费,10:C}");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"总计: { 总电费,10:C} ");
      }
  }
#+end_src

** 第一种方案的优化版

经过集思广益，整个班级一起修改，在上述的版本上进行优化:
- 减少了代码的冗余，让代码更清晰
- 将档位等数据提取为字段，方便管理和维护

代码如下:
#+begin_src csharp -n 
  class 电费计算
  {
      // 需要知道的数据
      private int _月份;
      private double _电数;

      // 需要计算出来的数据
      public double 第一档电费 { get; private set; }
      public double 第二档电费 { get; private set; }
      public double 第三档电费 { get; private set; }
      public double 总电费 { get => 第一档电费 + 第二档电费 + 第三档电费; }

      // 基准数据
      public static readonly int[] 夏季档位 = new int[] { 260, 600 };
      public static readonly int[] 冬季档位 = new int[] { 200, 400 };
      public static readonly double[] 档费 = new double[] { 0.600, 0.650, 0.900 };

      public void 月和电(int 月, double 电)
      {
          if (月 < 1 || 月 > 12 || 电 < 0)
          {
              Console.WriteLine("参数输入错误。");
              Environment.Exit(0);
          }
          _月份 = 月;
          _电数 = 电;
          计算电费();
      }

      public void 计算电费()
      {
          int p1 = 是夏季() ? 夏季档位[0] : 冬季档位[0];
          int p2 = 是夏季() ? 夏季档位[1] : 冬季档位[1];

          if (_电数 < p1)
          {
              第一档电费 = _电数 * 档费[0];
              第二档电费 = 0;
              第三档电费 = 0;
          }
          else if (_电数 < p2)
          {
              第一档电费 = p1 * 档费[0];
              第二档电费 = (_电数 - p1) * 档费[1];
              第三档电费 = 0;
          }
          else
          {
              第一档电费 = p1 * 档费[0];
              第二档电费 = (p2 - p1) * 档费[1];
              第三档电费 = (_电数 - p2) * 档费[2];
          }
      }

      public bool 是夏季()
      {
          return _月份 >= 5 && _月份 <= 10;
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"{_月份} 月的用电量是: {_电数} KWh");
          Console.WriteLine($"第一档电费: { 第一档电费,10:C}");
          Console.WriteLine($"第二档电费: { 第二档电费,10:C}");
          Console.WriteLine($"第三档电费: { 第三档电费,10:C}");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"总计: { 总电费,10:C} ");
      }
  }
#+end_src

** 第二种方案

基于阶梯度数，应该更加合理:

#+begin_src csharp -n
  class ElectricBillCal
  {
      // 基准数据
      public static readonly int[] 夏季档位 = new int[] { 260, 600 };
      public static readonly int[] 冬季档位 = new int[] { 200, 400 };
      public static readonly double[] 档费 = new double[] { 0.600, 0.650, 0.900 };

      // 需要知道的数据
      private int _月份;
      private double _电数;

      // 需要计算出来的数据
      private double[] _阶梯度数;
      public double 第一档电费 { get => _阶梯度数[0] * 档费[0]; }
      public double 第二档电费 { get => _阶梯度数[1] * 档费[1]; }
      public double 第三档电费 { get => _阶梯度数[2] * 档费[2]; }
      public double 总电费 { get => 第一档电费 + 第二档电费 + 第三档电费; }

      public void 设置月份和电数(int 月, double 数)
      {
          if (月 < 1 || 月 > 12 || 数 < 0) 抱怨并退出("参数输入错误");
          (_月份, _电数) = (月, 数);
          计算阶梯度数();
      }

      void 计算阶梯度数()
      {
          (int p1, int p2) = 夏天否() ? (夏季档位[0], 夏季档位[1]) : (冬季档位[0], 冬季档位[1]);

          if (_电数 <= p1)
          {
              _阶梯度数 = new double[] { _电数, 0, 0 };
          }
          else if (_电数 <= p2)
          {
              _阶梯度数 = new double[] { p1, _电数 - p1, 0 };
          }
          else
          {
              _阶梯度数 = new double[] { p1, p2 - p1, _电数 - p2 };
          }
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"{_月份} 月的用电量是: {_电数} KWh");
          Console.WriteLine($"第一档电费: {第一档电费,10:C}");
          Console.WriteLine($"第二档电费: {第二档电费,10:C}");
          Console.WriteLine($"第三档电费: {第三档电费,10:C}");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"总计: {总电费,10:C} ");
      }

      bool 夏天否() => _月份 >= 5 && _月份 <= 10;

      static void 抱怨并退出(string 抱怨内容)
      {
          Console.WriteLine(抱怨内容);
          Environment.Exit(0);
      }
  }
#+end_src

** 第二种方案的英文变量版本

用英文进行命名，还是比较主流和正规的。需要的只是简单的英文而已，写多了就熟了:

#+begin_src csharp -n
  class ElectricBillCalc
  {
      // 基准数据
      public static readonly int[] SummerLevels = { 260, 600 };
      public static readonly int[] WinterLevels = { 200, 400 };
      public static readonly double[] Rates = { 0.600, 0.650, 0.900 };

      // 需要知道的数据
      private int _month;
      private double _used;

      // 需要计算出来的数据
      private double[] lvUsed;
      public double Lv1Cost { get => lvUsed[0] * Rates[0]; }
      public double Lv2Cost { get => lvUsed[1] * Rates[1]; }
      public double Lv3Cost { get => lvUsed[2] * Rates[2]; }
      public double Bill { get => Lv1Cost + Lv2Cost + Lv3Cost; }

      public void SetMonthAndUsed(int month, double used)
      {
          if (month < 1 || month > 12 || used < 0) QuitWithReason("参数输入错误");
          (_month, _used) = (month, used);
          CalculateLvUsed();
      }

      void CalculateLvUsed()
      {
          (int p1, int p2) = IsSummer() ? (SummerLevels[0], SummerLevels[1]) : (WinterLevels[0], WinterLevels[1]);

          if (_used <= p1)
          {
              lvUsed = new [] { _used, 0, 0 };
          }
          else if (_used <= p2)
          {
              lvUsed = new [] { p1, _used - p1, 0 };
          }
          else
          {
              lvUsed = new [] { p1, p2 - p1, _used - p2 };
          }
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"{_month} 月的用电量是: {_used} KWh");
          Console.WriteLine($"第一档电费: {Lv1Cost,10:C}");
          Console.WriteLine($"第二档电费: {Lv2Cost,10:C}");
          Console.WriteLine($"第三档电费: {Lv3Cost,10:C}");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"总计: {Bill,10:C} ");
      }

      public void ExportToExcel()
      {
          // todo
      }

      bool IsSummer() => _month >= 5 && _month <= 10;

      static void QuitWithReason(string reason)
      {
          Console.WriteLine(reason);
          Environment.Exit(0);
      }
  }
#+end_src

** 学习怎么调用别人封装好的类和方法

#+begin_quote
完成 ElectricBillCalc 中杀马特版本的 Print:
- 1: 红色
- 2: 绿色
- 3: 黄色
- q: 或 esc 退出
- 回车: 每秒变一种颜色，适当增加声音效果 (beep)
- 其他: 原来的颜色
#+end_quote

- 首先理清楚思路，明白自己要做什么，不要着急写代码
- 碰到不会不懂的，要及时求助别人或度姨
- 解决问题过程中，一定要总结与反思 (带脑子)
- 问题解决了，笔记也要整理好 (温故知新，多练习)

#+begin_src csharp -n 210
  public void PrintFantasy()
  {
      PrintToConsole();
      while(true)
      {
          ConsoleKeyInfo key = Console.ReadKey();
          Console.Clear();
          if (key.Key == ConsoleKey.D1)
          {
              PrintToConsole(ConsoleColor.Red);
          }
          else if (key.Key == ConsoleKey.D2)
          {
              PrintToConsole(ConsoleColor.Green);
          }
          else if (key.Key == ConsoleKey.D3)
          {
              PrintToConsole(ConsoleColor.Yellow);
          }
          else if(key.Key == ConsoleKey.Enter)
          {
              int i = 0;
              while (true)
              {
                  ConsoleColor[] colors = new[] { ConsoleColor.Red, ConsoleColor.Green, ConsoleColor.Blue };
                  Console.Clear();
                  i = (i + 1) % colors.Length;
                  if (i == 1)
                  {
                      Console.Beep(90, 50);
                  }
                  else
                  {
                      Console.Beep(40, 50);
                  }
                  PrintToConsole(colors[i]);
                  Thread.Sleep(300);
              }
          }
          else
          {
              PrintToConsole();
          }
      }
  }

  public void PrintToConsole(ConsoleColor color)
  {
      Console.ForegroundColor = color;
      PrintToConsole();
      Console.ResetColor();
  }
#+end_src

** ExportToExcel

#+begin_src csharp -n
  public void ExportToExcel3()
  {
      HSSFWorkbook book = new HSSFWorkbook();    // 工作簿
      var sheet1 = book.CreateSheet("信息表");   // 工作表
      var sheet2 = book.CreateSheet("信息表2");  // 工作表

      // 第一行 (标题)

      var row1 = sheet1.CreateRow(3);

      var cell10 = row1.CreateCell(0);
      var cell11 = row1.CreateCell(1);
      var cell12 = row1.CreateCell(2);
      var cell13 = row1.CreateCell(3);
      var cell14 = row1.CreateCell(4);
      var cell15 = row1.CreateCell(5);
      var cell16 = row1.CreateCell(6);

      cell10.SetCellValue("月份");
      cell11.SetCellValue("度数");
      cell12.SetCellValue("一档费用");
      cell13.SetCellValue("二档费用");
      cell14.SetCellValue("三档费用");
      cell15.SetCellValue("总费用");

      // 第二行 (数据)

      var row2 = sheet1.CreateRow(1);

      var cell20 = row2.CreateCell(0);
      var cell21 = row2.CreateCell(1);
      var cell22 = row2.CreateCell(2);
      var cell23 = row2.CreateCell(3);
      var cell24 = row2.CreateCell(4);
      var cell25 = row2.CreateCell(5);
      var cell26 = row2.CreateCell(6);

      cell20.SetCellValue(_month);
      cell21.SetCellValue(_used);
      cell22.SetCellValue(Lv1Cost);
      cell23.SetCellValue(Lv2Cost);
      cell24.SetCellValue(Lv3Cost);
      cell25.SetCellValue(Bill);

      // 保存

      Console.WriteLine("开始导出...");
      FileStream file = new FileStream(@"D:\test.xls",FileMode.Create);
      book.Write(file);
      file.Close();
      book.Close();
  }
#+end_src

* 个税计算器 (简化版) [[id:6c800397-9525-4a5d-b857-4356fb81f85c][源]]
** 原始版本，*顺序* 执行

这是第二小组提供的代码:

#+begin_src csharp -n
  using System;

  namespace Tax
  {
      class Program
      {
          static void Main(string[] args)
          {
              double a = 0.03;
              double b = 0.05;
              double c = 0.2;
              double d = 0.45;
              double n;
              if (args.Length != 1 || !double.TryParse(args[0], out n))
              {
                  Console.WriteLine("去输入正确的格式：Tax 税前收入");
                  return;
              }
              else if (n < 5000)
              {
                  double tax1 = n;
                  Console.WriteLine($"税前收入：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{0,10:c}({0:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n:c}");
              }
              else if (n < 10000)
              {
                  double tax2 = (n - 5000) * a;
                  Console.WriteLine($"税前收入：{n, 10:c}");
                  Console.WriteLine($"应交税/税率：{tax2,10:c}({a:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax2:c}");
              }
              else if (n < 20000)
              {
                  double tax3 = (n - 10000) * b + 5000 * a;
                  Console.WriteLine($"税前收入：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{tax3,10:c}({b:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax3:c}");
              }
              else if (n < 100000)
              {
                  double tax4 = (n - 20000) * c + 10000 * b + 5000 * a;
                  Console.WriteLine($"税前收入：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{tax4,10:c}({c:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax4:c}");
              }

              else if (n > 100000)
              {
                  double tax6 = (n - 100000) * d + 80000 * c + 10000 * b + 5000 * a;
                  Console.WriteLine($"税前收入：{n,   10:c}");
                  Console.WriteLine($"应交税/税率：{tax6,10:c}({d:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax6:c}");
              }
          }
      }
  }
#+end_src

** 原始版本的批注

#+begin_src csharp
  namespace Tax
  {
      class Program
      {
          static void Main(string[] args)
          {
              // 变量的命名不要太随意!
              double a = 0.03;
              double b = 0.05;
              double c = 0.2;
              double d = 0.45;

              double n; // 税前收入

              if (args.Length != 1 || !double.TryParse(args[0], out n))
              {
                  Console.WriteLine("去输入正确的格式：Tax 应发工资");
                  return;
              }
              // else 没有必要
              else if (n < 5000)
              {
                  double tax1 = n; // 此变量的意义? 代码混淆
                  Console.WriteLine($"应发工资：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{0,10:c}({0:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n:c}");
              }
              else if (n < 10000) // 隐藏意思 1w > n >= 5k
              {
                  double tax2 = (n - 5000) * a; // 读到这里，才知晓 a 表示税率
                  Console.WriteLine($"应发工资：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{tax2,10:c}({a:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax2:c}");
              }
              else if (n < 20000)
              {
                  // 一定要善于模仿、山寨、抄袭，总之 C-c/C-v
                  // 模仿并不可耻，可耻的是，长年累月，没有任何进步
                  double tax3 = (n - 10000) * b + 5000 * a;
                  Console.WriteLine($"应发工资：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{tax3,10:c}({b:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax3:c}");
              }
              else if (n < 100000)
              {
                  double tax4 = (n - 20000) * c + 10000 * b + 5000 * a;
                  Console.WriteLine($"应发工资：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{tax4,10:c}({c:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax4:c}");
              }
              else if (n > 100000)
              {
                  // 冗余代码太多了，没必要的冗余会导致:
                  // - 开发起来，花费时间太多
                  // - 阅读起来，不是那么友好
                  // - 维护起来，越来越麻烦 (shi山)
                  double tax6 = (n - 100000) * d + 80000 * c + 10000 * b + 5000 * a;
                  Console.WriteLine($"应发工资：{n,10:c}");
                  Console.WriteLine($"应交税/税率：{tax6,10:c}({d:p})");
                  Console.WriteLine("".PadRight(30, '-'));
                  Console.WriteLine($"实发工资：{n - tax6:c}");
              }
          }
      }
  }
#+end_src

** 第四组优化版

#+begin_src csharp
  using System;

  // 命名要规范 ≠ 命名必须使用英文
  // 没必要因为英文失去了编程的信心
  // 如果能力可以，使用英文是推荐的，但是如果有些吃力，拼音也可以啊
  // 意思是: 如果能穿品牌出去自然好，但是没钱的话，干干净净也不丢人

  // 写代码，最重要的是有思路，也就是知道自己要做什么
  // 我们要做的事情是: 计算税后收入
  // - 第一步，接收税前收入的金额
  // - 第二步，按照 [ 税收 = 税前收入 * 恰当的税率 ] 的方式计算税率
  // - 第三步，通过 [ 税后收入 = 税前收入 - 税收 ] 的方式计算税后收入
  // - 最后，花样输出

  namespace Tax
  {
      class Program
      {
          static void Main(string[] args)
          {
              double slv;   //税率
              double ynsk;  //应纳税款
              double gongzi; //工资

              if (args.Length != 1 || !double.TryParse(args[0], out gongzi))
              {
                  Console.WriteLine("去输入正确的格式：Tax 税前收入");
                  return;
              }

              if (gongzi < 10000)
              {
                  slv = 0.03;
                  ynsk = (gongzi - 5000) * slv;
              }
              else if (gongzi < 20000)
              {
                  slv = 0.05;
                  ynsk = (gongzi - 5000) * slv;
              }
              else if (gongzi < 100000)
              {
                  slv = 0.2;
                  ynsk = (gongzi - 5000) * slv;
              }
              else
              {
                  slv = 0.45;
                  ynsk = (gongzi - 5000) * slv;
              }

              Console.WriteLine();
              Console.WriteLine($"税前收入：{gongzi,5:c}");
              Console.WriteLine($"应交税/税率：{ynsk,5:c}({slv:p})");
              Console.WriteLine("".PadRight(30, '-'));
              Console.WriteLine($"税后工资：{ gongzi - ynsk,5:c}");
          }
      }
  }

#+end_src

** *分离* 计算跟输出，优化代码结构

[[file:img/tax-cal.png]]


** 通过 *方法* 对逻辑进行提取

将某些代码块单独 *分离* 出来，并用一个名字代表，这就是所谓的方法。
在原先执行代码块的地方，使用这个名字代替，这就是方法调用。
通过这种方法调用方式，将程序变成了结构式的了，方便了重用和维护。

#+begin_src csharp
  using System;

  namespace Tax
  {
      class Program
      {
          static void Main(string[] args)
          {
              // 1. 接收参数
              double money;
              if (args.Length != 1 || !double.TryParse(args[0], out money))
              {
                  Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
                  return;
              }

              // 2. 按照接收的参数进行计算
              double[] result = CalculateTax(money);

              // 3. 对结果进行输出
              PrintToConsole(money, result[0], result[1]);

          }
          static double[] CalculateTax(double money)
          {
              double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
              double rate, tax;
              if (money <= 5000)
              {
                  rate = 0;
                  tax = 0;
              }
              else if (money < 10000)
              {
                  rate = rates[0];
                  tax = (money - 5000) * rate;
              }
              else if (money < 20000)
              {
                  rate = rates[1];
                  tax = (money - 10000) * rate + 5000 * rates[0];
              }
              else if (money < 100000)
              {
                  rate = rates[2];
                  tax = (money - 20000) * rate + 10000 * rates[1] + 5000 * rates[0];
              }
              else
              {
                  rate = rates[3];
                  tax = (money - 100000) * rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
              }
              return new double[] { rate, tax };
          }
          static void PrintToConsole(double money, double rate, double tax)
          {
              Console.WriteLine();
              Console.WriteLine($"税前收入: {money,10:C}");
              Console.WriteLine($"应付税收: {tax,10:C} ({rate:P1})");
              Console.WriteLine("".PadRight(30, '┈'));
              Console.WriteLine($"税后收入: {money - tax,10:C}");
          }
      }
  }
#+end_src

** 通过 *类* 对代码逻辑进行进一步分离

方法越来越多，需要按照功能进行分门别类。这样就更具备组织性了。

#+begin_src csharp
  using System;

  class Program
  {
      static void Main(string[] args)
      {
          // 1. 接收参数
          double money;
          if (args.Length != 1 || !double.TryParse(args[0], out money))
          {
              Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
              return;
          }

          // 税收的计算
          double[] result = TaxCal.CalculateTax(money);
          TaxCal.PrintToConsole(money, result[0], result[1]);
          TaxCal.ExportToExcel(money, result[0], result[1]);
      }
  }

  class TaxCal
  {
      static public double[] CalculateTax(double money)
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          double rate, tax;
          if (money <= 5000)
          {
              rate = 0;
              tax = 0;
          }
          else if (money < 10000)
          {
              rate = rates[0];
              tax = (money - 5000) * rate;
          }
          else if (money < 20000)
          {
              rate = rates[1];
              tax = (money - 10000) * rate + 5000 * rates[0];
          }
          else if (money < 100000)
          {
              rate = rates[2];
              tax = (money - 20000) * rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              rate = rates[3];
              tax = (money - 100000) * rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
          return new double[] {rate, tax};
      }
      static public void PrintToConsole(double money, double rate, double tax)
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {money,10:C}");
          Console.WriteLine($"应付税收: {tax,10:C} ({rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {money - tax,10:C}");
      }
      static public void ExportToExcel(double money, double rate, double tax)
      {
          Console.WriteLine();
          Console.WriteLine($"Excel输出税前收入: {money,10:C}");
          Console.WriteLine($"Excel输出应付税收: {tax,10:C} ({rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excel输出税后收入: {money - tax,10:C}");
      }
  }

  class TipCalculator { ... }
  class PowerFeeCalculator { ... }
#+end_src

** 让类中的各个方法，能 *共享数据*

在类中定义变量缓存每次方法调用的中间结果，下一个方法调用也可以直接使用这些缓存的结果。
这样，方法调用间就产生了关联，调用的时候不需要传递那么多参数。

#+begin_src csharp
  using System;

  class Program
  {
      static void Main(string[] args)
      {
          // 1. 接收参数
          double money;
          if (args.Length != 1 || !double.TryParse(args[0], out money))
          {
              Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
              return;
          }

          // 税收的计算
          TaxCal.money = money;
          TaxCal.CalculateTax();
          TaxCal.PrintToConsole();
          TaxCal.ExportToExcel();

          TaxCal.money = 23232;
          TaxCal.CalculateTax();
          TaxCal.PrintToConsole();
      }
  }

  class TaxCal
  {
      static public double money;
      static private double rate;
      static private double tax;

      static public void CalculateTax()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          //double rate, tax;
          if (money <= 5000)
          {
              rate = 0;
              tax = 0;
          }
          else if (money < 10000)
          {
              rate = rates[0];
              tax = (money - 5000) * rate;
          }
          else if (money < 20000)
          {
              rate = rates[1];
              tax = (money - 10000) * rate + 5000 * rates[0];
          }
          else if (money < 100000)
          {
              rate = rates[2];
              tax = (money - 20000) * rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              rate = rates[3];
              tax = (money - 100000) * rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      static public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {money,10:C}");
          Console.WriteLine($"应付税收: {tax,10:C} ({rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {money - tax,10:C}");
      }
      static public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"Excel输出税前收入: {money,10:C}");
          Console.WriteLine($"Excel输出应付税收: {tax,10:C} ({rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excel输出税后收入: {money - tax,10:C}");
      }
  }
#+end_src

** 引入 *对象* 保证调用的数据安全

引入独立的存储空间，将方法共享的数据进行隔离:

#+ATTR_HTML: :width 400
[[file:img/tax-cal3.png]]

#+begin_src csharp
  using System;

  class Program
  {
      static void Main(string[] args)
      {
          // 1. 接收参数
          double money;
          if (args.Length != 1 || !double.TryParse(args[0], out money))
          {
              Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
              return;
          }

          TaxCal tc1 = new TaxCal();
          tc1.money = money;
          tc1.CalculateTax();
          tc1.PrintToConsole();

          TaxCal tc2 = new TaxCal();
          tc2.money = 33333;
          tc2.CalculateTax();
          tc2.ExportToExcel();

          tc1.ExportToExcel();
      }
  }

  class TaxCal
  {
      public double money;
      private double rate;
      private double tax;

      public void CalculateTax()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (money <= 5000)
          {
              rate = 0;
              tax = 0;
          }
          else if (money < 10000)
          {
              rate = rates[0];
              tax = (money - 5000) * rate;
          }
          else if (money < 20000)
          {
              rate = rates[1];
              tax = (money - 10000) * rate + 5000 * rates[0];
          }
          else if (money < 100000)
          {
              rate = rates[2];
              tax = (money - 20000) * rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              rate = rates[3];
              tax = (money - 100000) * rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {money,10:C}");
          Console.WriteLine($"应付税收: {tax,10:C} ({rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {money - tax,10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"Excel输出税前收入: {money,10:C}");
          Console.WriteLine($"Excel输出应付税收: {tax,10:C} ({rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excel输出税后收入: {money - tax,10:C}");
      }
  }
#+end_src

** 通过 [private Field + public Method] 的方式，*保护数据* 安全

面向对象的数据的封装 (数据的安全):
- 对象是按照类的模板创建的包含了若干数据的一段存储空间
- 后续的方法调用都是基于对象的这片存储空间的
- 因此，我们需要通过一定手段对对象里的数据进行相关的访问保护
- 通用手段是提供了 private/public/protected 访问权限修饰符
  + 如果修饰为 private 的话，那么字段的数据从外部是禁止访问的 (不读、不写)
  + 如果修饰为 public 的话，那么字段的数据从外部是可以无限制访问的 (读、写)
  + 默认的修饰符为 private，也就是如果不添加任何修饰符的话，默认是不读、不写
- 当然，有时候，我们需要对一些数据或方法有特殊的要求，比如只读或只写:
  + 只读: 1) 将字段设置为 private 2) 创建一个 public 的方法，这个方法能够间接返回字段的值
  + 只写: 1) 将字段设置为 private 2) 创建一个 public 的方法，在这个方法中可以为字段赋值
  + 可控的读跟写: 1) 将字段设为 private 2) 创建两个方法，一个用来读 (Get)，一个用来写 (Set)

#+ATTR_HTML: :width 400
[[file:img/tax-cal2.png]]


于是，上述的这种模式，*private 字段 + public 方法*，成为了一种标准的编程实践:

#+begin_src csharp
  using System;

  class Program
  {
      static void Main(string[] args)
      {
          double money;
          if (args.Length != 1 || !double.TryParse(args[0], out money))
          {
              Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
              return;
          }

          TaxCal tc1 = new TaxCal();
          tc1.SetMoney(8000);
          Console.WriteLine(tc1.GetMoney());

          tc1.PrintToConsole();
          tc1.ExportToExcel();
          tc1.SetMoney(333333333);
          Console.WriteLine(">>> {0}", tc1.GetRate());
      }
  }

  class TaxCal
  {
      private double Money;
      private double Rate;
      private double Tax;

      public double GetMoney()
      {
          return Money;
      }
      public void SetMoney(double duoshao)
      {
          if (duoshao < 0)
          {
              Console.WriteLine("\n参数输入格式不正确！");
              Environment.Exit(0);
          }
          Money = duoshao;
      }
      public double GetTax()
      {
          CalculateTax();
          return Tax;
      }
      public double GetRate()
      {
          CalculateTax();
          return Rate;
      }

      public void CalculateTax()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (Money <= 5000)
          {
              Rate = 0;
              Tax = 0;
          }
          else if (Money < 10000)
          {
              Rate = rates[0];
              Tax = (Money - 5000) * Rate;
          }
          else if (Money < 20000)
          {
              Rate = rates[1];
              Tax = (Money - 10000) * Rate + 5000 * rates[0];
          }
          else if (Money < 100000)
          {
              Rate = rates[2];
              Tax = (Money - 20000) * Rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              Rate = rates[3];
              Tax = (Money - 100000) * Rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      public void PrintToConsole()
      {
          CalculateTax();
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
      public void ExportToExcel()
      {
          CalculateTax();
          Console.WriteLine();
          Console.WriteLine($"Excel输出税前收入: {Money,10:C}");
          Console.WriteLine($"Excel输出应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excel输出税后收入: {Money - Tax,10:C}");
      }
  }
#+end_src

** 减少代码冗余，*Lazy* and *Eager*

#+begin_src csharp
  class Program
  {
      static void Main(string[] args)
      {
          double money;
          if (args.Length != 1 || !double.TryParse(args[0], out money))
          {
              Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
              return;
          }

          TaxCal tc1 = new TaxCal();
          tc1.SetMoney(money);
          Console.WriteLine(tc1.GetTax());
          tc1.PrintToConsole();
      }
  }
#+end_src

#+begin_src csharp
  class TaxCal
  {
      private double Money;
      private double Rate;
      private double Tax;

      public double GetMoney()
      {
          return Money;
      }
      public void SetMoney(double duoshao)
      {
          if (duoshao < 0)
          {
              Console.WriteLine("\n参数输入格式不正确！");
              Environment.Exit(0);
          }
          Money = duoshao;
          CalculateTax(); // 更新对象中的 Tax 和 Rate
      }
      public double GetRate()
      {
          return Rate;
      }
      public double GetTax()
      {
          return Tax;
      }

      public void CalculateTax()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (Money <= 5000)
          {
              Rate = 0;
              Tax = 0;
          }
          else if (Money < 10000)
          {
              Rate = rates[0];
              Tax = (Money - 5000) * Rate;
          }
          else if (Money < 20000)
          {
              Rate = rates[1];
              Tax = (Money - 10000) * Rate + 5000 * rates[0];
          }
          else if (Money < 100000)
          {
              Rate = rates[2];
              Tax = (Money - 20000) * Rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              Rate = rates[3];
              Tax = (Money - 100000) * Rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"Excel输出税前收入: {Money,10:C}");
          Console.WriteLine($"Excel输出应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excel输出税后收入: {Money - Tax,10:C}");
      }
  }
#+end_src

#+begin_src csharp
  class TaxCalLazy
  {
      private double Money;

      public double GetMoney()
      {
          return Money;
      }
      public void SetMoney(double duoshao)
      {
          if (duoshao < 0)
          {
              Console.WriteLine("\n参数输入格式不正确！");
              Environment.Exit(0);
          }
          Money = duoshao;
      }

      public double GetTax()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (Money <= 5000)
          {
              return 0;
          }
          else if (Money < 10000)
          {
              return (Money - 5000) * rates[0];
          }
          else if (Money < 20000)
          {
              return (Money - 10000) * rates[1] + 5000 * rates[0];
          }
          else if (Money < 100000)
          {
              return (Money - 20000) * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              return (Money - 100000) * rates[3] + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      public double GetRate()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (Money <= 5000)
          {
              return 0;
          }
          else if (Money < 10000)
          {
              return rates[0];
          }
          else if (Money < 20000)
          {
              return rates[1];
          }
          else if (Money < 100000)
          {
              return rates[2];
          }
          else
          {
              return rates[3];
          }
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {GetTax(),10:C} ({GetRate():P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - GetTax(),10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"Excel输出税前收入: {Money,10:C}");
          Console.WriteLine($"Excel输出应付税收: {GetTax(),10:C} ({GetRate():P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excel输出税后收入: {Money - GetTax(),10:C}");
      }
  }
#+end_src

** 来自语法糖的力量: 通过 *Property* 简化代码
*** Eager Version

#+begin_div :class mc11

#+begin_src csharp
  class TaxCal
  {
      private double Money;
      private double Rate;
      private double Tax;

      public double GetMoney()
      {
          return Money;
      }
      public void SetMoney(double duoshao)
      {
          if (duoshao < 0)
          {
              Console.WriteLine("\n参数输入格式不正确！");
              Environment.Exit(0);
          }
          Money = duoshao;
          CalculateTax(); // 更新对象中的 Tax 和 Rate
      }
      public double GetRate()
      {
          return Rate;
      }
      public double GetTax()
      {
          return Tax;
      }

      public void CalculateTax()
      {
          double[] rates = new double[]{0.03, 0.05, 0.2, 0.45};
          if (Money <= 5000)
          {
              Rate = 0;
              Tax = 0;
          }
          else if (Money < 10000)
          {
              Rate = rates[0];
              Tax = (Money - 5000) * Rate;
          }
          else if (Money < 20000)
          {
              Rate = rates[1];
              Tax = (Money - 10000) * Rate ...;
          }
          else if (Money < 100000)
          {
              Rate = rates[2];
              Tax = (Money - 20000) * Rate ...;
          }
          else
          {
              Rate = rates[3];
              Tax = (Money - 100000) * Rate ...;
          }
      }
      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
  }
#+end_src

:break:

#+begin_src csharp
class TaxCal
{
    private double _money; // 用来承载后面的数据，税前收入
    public double Money
    {
        get { return _money; } // xxxx.Money
        set                    // xxxx.Money = 3333;
        {
            if (value < 0)
            {
                Console.WriteLine("\n参数输入格式不正确！");
                Environment.Exit(0);
            }
            _money = value;
            CalculateTax();
        }
    }
    public double Rate { get; private set; }
    public double Tax { get; private set; }

    public void CalculateTax()
    {
        double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
        if (Money <= 5000)
        {
            Rate = 0;
            Tax = 0;
        }
        else if (Money < 10000)
        {
            Rate = rates[0];
            Tax = (Money - 5000) * Rate;
        }
        else if (Money < 20000)
        {
            Rate = rates[1];
            Tax = (Money - 10000) * Rate + 5000 * rates[0];
        }
        else if (Money < 100000)
        {
            Rate = rates[2];
            Tax = (Money - 20000) * Rate + 10000 * rates[1] + 5000 * rates[0];
        }
        else
        {
            Rate = rates[3];
            Tax = (Money - 100000) * Rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
        }
    }
    public void PrintToConsole()
    {
        Console.WriteLine();
        Console.WriteLine($"税前收入: {Money,10:C}");
        Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
        Console.WriteLine("".PadRight(30, '┈'));
        Console.WriteLine($"税后收入: {Money - Tax,10:C}");
    }
    public void ExportToExcel()
    {
        Console.WriteLine();
        Console.WriteLine($"税前收入: {Money,10:C}");
        Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
        Console.WriteLine("".PadRight(30, '┈'));
        Console.WriteLine($"税后收入: {Money - Tax,10:C}");
    }
}
#+end_src
#+end_div

*** Lazy Version

#+begin_div :class mc11

#+begin_src csharp
  class TaxCalLazy
  {
      private double Money;

      public double GetMoney()
      {
          return Money;
      }
      public void SetMoney(double duoshao)
      {
          if (duoshao < 0)
          {
              Console.WriteLine("\n参数输入格式不正确！");
              Environment.Exit(0);

          }
          Money = duoshao;
      }

      public double GetTax()
      {
          double[] rates = new double[]{0.03, 0.05, 0.2, 0.45};
          if (Money <= 5000)
          {
              return 0;
          }
          else if (Money < 10000)
          {
              return (Money - 5000) * rates[0];
          }
          else if (Money < 20000)
          {
              return (Money - 10000) * rates[1] + ...;
          }
          else if (Money < 100000)
          {
              return (Money - 20000) * rates[2] + ...;
          }
          else
          {
              return (Money - 100000) * rates[3] + ...;
          }
      }
      public double GetRate()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (Money <= 5000)
          {
              return 0;
          }
          else if (Money < 10000)
          {
              return rates[0];
          }
          else if (Money < 20000)
          {
              return rates[1];
          }
          else if (Money < 100000)
          {
              return rates[2];
          }
          else
          {
              return rates[3];
          }
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {GetTax(),10:C} ({GetRate():P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - GetTax(),10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {GetTax(),10:C} ({GetRate():P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - GetTax(),10:C}");
      }
  }

#+end_src

:break:

#+begin_src csharp
  class TaxCalLazy
  {
      private double _money;
      public double Money
      {
          get { return _money; }
          set
          {
              if (value < 0)
              {
                  Console.WriteLine("\n参数输入格式不正确！");
                  Environment.Exit(0);

              }
              _money = value;
          }
      }
      public double Tax
      {
          get
          {
              double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
              if (Money <= 5000)
              {
                  return 0;
              }
              else if (Money < 10000)
              {
                  return (Money - 5000) * rates[0];
              }
              else if (Money < 20000)
              {
                  return (Money - 10000) * rates[1] + 5000 * rates[0];
              }
              else if (Money < 100000)
              {
                  return (Money - 20000) * rates[2] + 10000 * rates[1] + 5000 * rates[0];
              }
              else
              {
                  return (Money - 100000) * rates[3] + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
              }
          }
      }
      public double Rate
      {
          get
          {
              double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
              if (Money <= 5000)
              {
                  return 0;
              }
              else if (Money < 10000)
              {
                  return rates[0];
              }
              else if (Money < 20000)
              {
                  return rates[1];
              }
              else if (Money < 100000)
              {
                  return rates[2];
              }
              else
              {
                  return rates[3];
              }
          }
      }

      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
  }
#+end_src
#+end_div

** 使用 *Constructor* 进行对象的个性化构建

使用构造方法，让对象在创建的时候，进行必要的初始化工作。

每个类都需要有构造方法，构造方法就是一种特殊的方法:
#+begin_src csharp
  class TaxCal
  {
      public TaxCal(double money)
      {
          Money = money;
      }
    
      private double _money;
      public double Money
      {
          get { return _money; } // xxxx.Money
          set                    // xxxx.Money = 3333;
          {
              if (value < 0)
              {
                  Console.WriteLine("\n参数输入格式不正确！");
                  Environment.Exit(0);
              }
              _money = value;
              CalculateTax();
          }
      }
      public double Rate { get; private set; }
      public double Tax { get; private set; }

      public void CalculateTax()
      {
          double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };
          if (Money <= 5000)
          {
              Rate = 0;
              Tax = 0;
          }
          else if (Money < 10000)
          {
              Rate = rates[0];
              Tax = (Money - 5000) * Rate;
          }
          else if (Money < 20000)
          {
              Rate = rates[1];
              Tax = (Money - 10000) * Rate + 5000 * rates[0];
          }
          else if (Money < 100000)
          {
              Rate = rates[2];
              Tax = (Money - 20000) * Rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              Rate = rates[3];
              Tax = (Money - 100000) * Rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
  }

  class Program
  {
      static void Main()
      {
          var t = new TaxCal(20000); // 必须使用带参数的构造器进行初始化
          t.PrintToConsole();
      }
  }
#+end_src

** 使用 *static* 将某些数据归属于类，达到数据共享的目的

世界大势，合久必分，分久必合。使用对象将数据进行有效分离，使用 static 将某些数据归属于类，从而在实例间进行共享。

共享了就有被误操作的风险，所以，可以通过 const/readonly 保证字段不会被随意修改。

#+begin_src csharp
  using System;

  class Program
  {
      static void Main(string[] args)
      {
          double money;
          if (args.Length != 1 || !double.TryParse(args[0], out money))
          {
              Console.WriteLine("您的输入有误，正确的调用方法是:\nTaxCalculator 税前收入");
              return;
          }

          TaxCal t = new TaxCal(22323);
          t.PrintToConsole();
      }
  }

  class TaxCal
  {
      public TaxCal(double m)
      {
          Money = m;
      }

      private double _money; // 用来承载后面的数据，税前收入
      private static readonly double[] rates = new double[] { 0.03, 0.05, 0.2, 0.45 };

      public double Money
      {
          get => _money; // xxxx.Money
          set                    // xxxx.Money = 3333;
          {
              if (value < 0)
              {
                  Console.WriteLine("\n参数输入格式不正确！");
                  Environment.Exit(0);
              }
              _money = value;
              CalculateTax();
          }
      }
      public double Rate { get; private set; }
      public double Tax { get; private set; }

      public void CalculateTax()
      {
          if (Money <= 5000)
          {
              Rate = 0;
              Tax = 0;
          }
          else if (Money < 10000)
          {
              Rate = rates[0];
              Tax = (Money - 5000) * Rate;
          }
          else if (Money < 20000)
          {
              Rate = rates[1];
              Tax = (Money - 10000) * Rate + 5000 * rates[0];
          }
          else if (Money < 100000)
          {
              Rate = rates[2];
              Tax = (Money - 20000) * Rate + 10000 * rates[1] + 5000 * rates[0];
          }
          else
          {
              Rate = rates[3];
              Tax = (Money - 100000) * Rate + 80000 * rates[2] + 10000 * rates[1] + 5000 * rates[0];
          }
      }
      public void PrintToConsole()
      {
          Console.WriteLine();
          Console.WriteLine($"税前收入: {Money,10:C}");
          Console.WriteLine($"应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"税后收入: {Money - Tax,10:C}");
      }
      public void ExportToExcel()
      {
          Console.WriteLine();
          Console.WriteLine($"Excle输出税前收入: {Money,10:C}");
          Console.WriteLine($"Excle输出应付税收: {Tax,10:C} ({Rate:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"Excle输出税后收入: {Money - Tax,10:C}");
      }
      public static void ShowRates()
      {
          foreach (double r in rates)
          {
              Console.WriteLine($"- {r}");
          }
      }
  }
#+end_src



** 小结

* 小费计算器
** 核心代码

#+begin_src csharp
  // Main 方法是程序的入口
  // args 表示从控制台传来的参数数据
  // 比如，在 CMD 窗口输入 TipCalculator 222 333 444，那么:
  //   - args[0] 就是字符串 222
  //   - args[1] 就是字符串 333
  //   - args[2] 就是字符串 444
  static void Main(string[] args)
  {
      // 字符串是用来描述世界的方式，它不能参与数学计算。
      // 因此要计算，需要先转换成合适的格式，比如 double 类型

      // 账单
      double bill = double.Parse(args[0]);
      // 小费计算
      double rate = 0.18;
      double tip = bill * rate;
      // 实际账单计算
      double realBill = bill + tip;

      // 输出
      Console.WriteLine("{0}", realBill);
  }
#+end_src

** 在核心代码上进行优化

#+begin_src csharp
  // 目标:
  // 1. 让程序更健壮，避免不必要的异常抛出
  // 2. 让输出更加美观，用户体验更友好

  static void Main(string[] args)
  {
      // 声明一个变量，用来保存转换后的账单数目
      double bill;

      // 检查用户输入，如果输入不合理，给予提醒并退出程序
      // double.Parse 和 double.TryParse 都是用来将 string 类型的数据转换为 double 类型:
      //  - Parse 会在转换失败的时候抛出异常，所以如果想让程序运行良好，需要结合 try..catch 进行错误处理
      //  - TryParse 可通过返回 true/false 的方式判断转换成功与否，需要结合 out 参数存储转换后的值
      // if 是一种基本的程序流程，表示只有满足条件的时候，其代码块才会被执行。它是对顺序结构的补充
      // return 表示退出当前方法的运行。如果在 Main 方法中，则表示退出程序的运行
      //
      // 下面一句的意思是: 如果输入的参数不是 1 个，或者输入的参数不能转换为 double，那么提醒用户并退出
      if (args.Length != 1 || !double.TryParse(args[0], out bill))
      {
          Console.WriteLine("您的输入有误，正确的调用方法是:\nTipCalculator 账单数额");
          return;
      }

      // 小费以及实际账单的计算
      double rate = 0.18;
      double tip = bill * rate;
      double realBill = bill + tip;

      // 进行格式化输出，即将某个类型的数值，转换成预期格式的字符串:
      // - 使用 $ 符号，可以对变量进行内插操作; 使用 @ 可以忽略转义并运行多行字符串
      // - 通过 {a:X} 可以使用 C# 预设的某些转换规则进行转换。比如 C 表示货币，P 表示百分比
      // - 使用 {a,N} 的方式，让转换后的字符串满足 N 的长度。如果不满足，使用空格补齐。-N 表示左对齐
      // - 可以结合使用，语法为 {a,N:X...}，比如 {rate,10:P1} 表示按照百分比显示、小数保留一位、补齐为 10 的长度
      // string.PadRight 是内置的一个字符串操作的 API，表示将字符串使用某个字符补齐为多少长度
      Console.WriteLine();
      Console.WriteLine($"账单总额: {bill,10:C}");
      Console.WriteLine($"小费数额: {tip,10:C} ({rate:P1})");
      Console.WriteLine("".PadRight(30, '┈'));
      Console.WriteLine($"账单实付: {realBill,10:C}");
  }
#+end_src

** 结构化重构

#+begin_src csharp -n
  class TipCal
  {
      public TipCal(double bill)
      {
          Bill = bill;
      }

      const double RATE = 0.18;
      public double Bill { get; private set; }
      public double Tip { get { return Bill * RATE; } }

      public void Print()
      {
          Console.WriteLine();
          Console.WriteLine($"账单总额: {Bill,10:C}");
          Console.WriteLine($"小费数额: {Tip,10:C} ({RATE:P1})");
          Console.WriteLine("".PadRight(30, '┈'));
          Console.WriteLine($"账单实付: {Bill + Tip,10:C}");
      }
  }
#+end_src
